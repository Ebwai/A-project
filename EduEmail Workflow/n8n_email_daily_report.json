{
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "minutes",
              "minutesInterval": 10
            }
          ]
        }
      },
      "id": "4ddda705-34db-40b7-b537-96bf2db8803f",
      "name": "æ¯10åˆ†é’Ÿè§¦å‘",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1,
      "position": [
        -3392,
        160
      ]
    },
    {
      "parameters": {
        "operation": "getAll",
        "returnAll": true,
        "output": "raw",
        "filtersUI": {
          "values": {
            "filters": {
              "readStatus": "unread"
            }
          }
        },
        "options": {
          "attachmentsPrefix": "data_",
          "downloadAttachments": true
        }
      },
      "id": "bbdaf290-0c70-4f7b-8084-e5755729fb5d",
      "name": "è·å– Outlook é‚®ä»¶",
      "type": "n8n-nodes-base.microsoftOutlook",
      "typeVersion": 2,
      "position": [
        -3184,
        160
      ],
      "webhookId": "5f443408-6f7e-4ae1-ba94-5bbfe85d455b",
      "credentials": {
        "microsoftOutlookOAuth2Api": {
          "id": "zosb6ZPeueosMnPx",
          "name": "Microsoft Outlook account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// 1. åœ¨è¿™é‡Œå¡«å…¥ä½  Outlook å„ä¸ªæ–‡ä»¶å¤¹çš„çœŸå® Folder ID\nconst folderIds = {\n  important: \"AQMkADAwATM0MDAAMS0wMzRlLWU0ZDQtMDACLTAwCgAuAAADGxqcrOJwqkOUDVnFcw_6SQEAhrNBk7nAs0q97X6LwbAwYQAHwsT2UwAAAA==\",\n  highJob: \"AQMkADAwATM0MDAAMS0wMzRlLWU0ZDQtMDACLTAwCgAuAAADGxqcrOJwqkOUDVnFcw_6SQEAhrNBk7nAs0q97X6LwbAwYQAHwsT2UgAAAA==\",\n  lowJob: \"AQMkADAwATM0MDAAMS0wMzRlLWU0ZDQtMDACLTAwCgAuAAADGxqcrOJwqkOUDVnFcw_6SQEAhrNBk7nAs0q97X6LwbAwYQAHwsT2UQAAAA==\",\n  highActivity: \"AQMkADAwATM0MDAAMS0wMzRlLWU0ZDQtMDACLTAwCgAuAAADGxqcrOJwqkOUDVnFcw_6SQEAhrNBk7nAs0q97X6LwbAwYQAHwsT2UAAAAA==\",\n  lowActivity: \"AQMkADAwATM0MDAAMS0wMzRlLWU0ZDQtMDACLTAwCgAuAAADGxqcrOJwqkOUDVnFcw_6SQEAhrNBk7nAs0q97X6LwbAwYQAHwsT2TwAAAA==\",\n  overseas: \"AQMkADAwATM0MDAAMS0wMzRlLWU0ZDQtMDACLTAwCgAuAAADGxqcrOJwqkOUDVnFcw_6SQEAhrNBk7nAs0q97X6LwbAwYQAHwsT2VAAAAA==\", \n  trivia: \"AQMkADAwATM0MDAAMS0wMzRlLWU0ZDQtMDACLTAwCgAuAAADGxqcrOJwqkOUDVnFcw_6SQEAhrNBk7nAs0q97X6LwbAwYQAHwiwjaQAAAA==\",\n  rubbish: \"AQMkADAwATM0MDAAMS0wMzRlLWU0ZDQtMDACLTAwCgAuAAADGxqcrOJwqkOUDVnFcw_6SQEAhrNBk7nAs0q97X6LwbAwYQAHwsT2TgAAAA==\"\n};\n\n// 2. éå†ä¸Šä¸€å±‚ä¼ è¿›æ¥çš„æ‰€æœ‰é‚®ä»¶æ•°æ®\nfor (const item of $input.all()) {\n  let rawSubject = item.json.subject || \"\";\n\n  // å…¼å®¹ Structured Output Parser çš„è¾“å‡º\n  let ai = item.json.output || item.json.text || item.json;\n  if (typeof ai === 'string') {\n    try { ai = JSON.parse(ai); } catch(e) { ai = {}; }\n  }\n\n  let realSender = (ai.originalSender || item.json.sender?.emailAddress?.address || \"\").toLowerCase();\n\n  let ruleScore = 0;\n  let prefScore = 0;\n\n  // --- è§„åˆ™æ¨¡å— ---\n  if (realSender.includes('gradschool@cuhk.edu.hk') || realSender.includes('mscinfo@ee.cuhk.edu.hk')) {\n    ruleScore += 5;\n  }\n  let subLower = rawSubject.toLowerCase();\n  if (subLower.includes('urgent') || subLower.includes('important')) {\n    ruleScore += 5;\n  }\n\n  // ğŸ”¥ æ–°å¢ï¼šäº¤å­¦è´¹ã€äº¤ä½œä¸šã€è€ƒè¯•ç›´æ¥æ‹‰æ»¡ 5 åˆ†ï¼\n  if (ai.isImportantAcademicOrFee) {\n    ruleScore += 5;\n  }\n\n  if (ai.isPersonalOrCompany) ruleScore += 4;\n  if (ai.hasDeadline) ruleScore += 1;\n  if (ai.isActivity) ruleScore += 1; \n  if (ai.isEngineeringOrEE) ruleScore += 1; \n  if (ai.hasGiveaway) ruleScore += 2;\n  if (ai.isJobHunting) ruleScore += 1;\n  if (ai.isOverseasExchange) ruleScore += 1;\n  if (ai.hasSubsidy) ruleScore += 1;\n\n  // --- åå¥½æ¨¡å— ---\n  if (ai.prefEmbedded) prefScore += 1;\n  if (ai.prefBigTech) prefScore += 1;\n  if (ai.prefEntertainment) prefScore += 1;\n\n  let totalScore = Math.min(ruleScore + prefScore, 5);\n\n  // --- ç±»åˆ«æ ‡è®° (å†³å®šå»å“ªä¸ªç±»åˆ«çš„æ–‡ä»¶å¤¹) ---\n  let category = \"trivia\";\n  if (ai.isJobHunting) {\n    category = \"job\";\n  } else if (ai.isOverseasExchange) {\n    category = \"overseas\";\n  } else if (ai.isActivity) {\n    category = \"activity\";\n  }\n\n  // --- åŠ¨æ€åˆ†é…æ–‡ä»¶å¤¹ç›®æ ‡ ID ---\n  let targetFolderId = folderIds.rubbish;\n  if (totalScore === 5) {\n    targetFolderId = folderIds.important;\n  } else if (totalScore >= 2) {\n    if (category === \"job\") {\n      targetFolderId = folderIds.highJob;\n    } else if (category === \"overseas\") {\n      targetFolderId = folderIds.overseas;\n    } else if (category === \"activity\") {\n      targetFolderId = (totalScore >= 3) ? folderIds.highActivity : folderIds.lowActivity;\n    } else {\n      targetFolderId = folderIds.trivia;\n    }\n  } else {\n    targetFolderId = folderIds.rubbish;\n  }\n\n  // 3. å°†è®¡ç®—å‡ºçš„æ ‡ç­¾ç›´æ¥å†™å›åˆ°å½“å‰è¿™å°é‚®ä»¶çš„æ•°æ®æµä¸­\n  item.json.realSender = realSender;\n  item.json.finalScore = totalScore;\n  item.json.emailCategory = category;\n  item.json.targetFolderId = targetFolderId;\n  item.json.aiSummary = ai.emailSummary || item.json.bodyPreview || \"\";\n\n  // ğŸ”¥ æ–°å¢ï¼šå°†æ—¥å†äº‹ä»¶ç›¸å…³ä¿¡æ¯ç›´æ¥æå–åˆ°å¤–å±‚ï¼Œæ–¹ä¾¿åé¢ç›´æ¥å»ºæ—¥å†ï¼\n  item.json.has_event = ai.has_event || false;\n  item.json.event_title = ai.event_title || \"\";\n  item.json.start_time = ai.start_time || \"\";\n  item.json.end_time = ai.end_time || \"\";\n  item.json.location = ai.location || \"\";\n}\n\n// 4. è¿”å›å¤„ç†å®Œçš„æ•´ä¸ªæ•°ç»„å¾€ä¸‹ä¼ \nreturn $input.all();"
      },
      "id": "c3139c89-fe62-4c24-b530-259def760f95",
      "name": "æ‰“åˆ†å¼•æ“ä¸è·¯ç”±è®¡ç®—",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -976,
        144
      ]
    },
    {
      "parameters": {
        "operation": "move",
        "messageId": {
          "__rl": true,
          "value": "={{ $('è·å– Outlook é‚®ä»¶').item.json.id }}",
          "mode": "id"
        },
        "folderId": {
          "__rl": true,
          "value": "={{ $('æ‰“åˆ†å¼•æ“ä¸è·¯ç”±è®¡ç®—').item.json.targetFolderId }}",
          "mode": "id"
        }
      },
      "id": "91488d5b-032d-4e49-ad12-64d6ba0af009",
      "name": "åŠ¨æ€ç§»åŠ¨è‡³å¯¹åº”æ–‡ä»¶å¤¹",
      "type": "n8n-nodes-base.microsoftOutlook",
      "typeVersion": 2,
      "position": [
        -560,
        144
      ],
      "webhookId": "91b608fa-8b43-4685-8cfd-290b517b1cee",
      "credentials": {
        "microsoftOutlookOAuth2Api": {
          "id": "zosb6ZPeueosMnPx",
          "name": "Microsoft Outlook account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{ $('æ‰“åˆ†å¼•æ“ä¸è·¯ç”±è®¡ç®—').item.json.finalScore }}",
              "operation": "equal",
              "value2": 5
            }
          ]
        }
      },
      "id": "0788c8c5-9be2-4bc8-9a5c-16324973eec3",
      "name": "æ»¡åˆ† 5 åˆ†?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        -320,
        144
      ]
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{ $('æ‰“åˆ†å¼•æ“ä¸è·¯ç”±è®¡ç®—').item.json.finalScore }}",
              "operation": "largerEqual",
              "value2": 2
            }
          ]
        }
      },
      "id": "3fc60bea-f66d-4120-b5f6-f2cdebff9500",
      "name": "å¤§äºç­‰äº 2 åˆ†?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        -64,
        288
      ]
    },
    {
      "parameters": {
        "command": "=echo '{\"subject\":\"{{ $('è·å– Outlook é‚®ä»¶').item.json.subject }}\", \"sender\":\"{{ $('AI åˆ†æè¯­ä¹‰ä¸çœŸå®å‘ä»¶äºº').item.json.output.originalSender }}\", \"score\":{{ $('æ‰“åˆ†å¼•æ“ä¸è·¯ç”±è®¡ç®—').item.json.finalScore }}, \"category\":\"{{ $('æ‰“åˆ†å¼•æ“ä¸è·¯ç”±è®¡ç®—').item.json.emailCategory }}\", \"content\":\"{{ $('æ‰“åˆ†å¼•æ“ä¸è·¯ç”±è®¡ç®—').item.json.output.emailSummary }}\"}' >> /files/daily_emails.jsonl"
      },
      "id": "a01edbe0-f89a-46da-bf5b-60694ff8e166",
      "name": "è¿½åŠ è‡³æœ¬åœ° JSONL",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [
        208,
        272
      ]
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "={\n  \"type\": \"object\",\n  \"properties\": {\n    \"originalSender\": {\n      \"type\": \"string\",\n      \"description\": \"æå–çœŸæ­£çš„å‘ä»¶äººé‚®ç®±ã€‚å¦‚æœæ­£æ–‡ä¸­åŒ…å« From: xxx@yy.com æˆ–å‘ä»¶äºº: xxx ç­‰è½¬å‘è®°å½•ï¼Œæå–è¯¥åŸå§‹é‚®ç®±ï¼›è‹¥å®åœ¨æ‰¾ä¸åˆ°ï¼Œå¡«è¡¨é¢å‘ä»¶äºº\"\n    },\n    \"isPersonalOrCompany\": {\n      \"type\": \"boolean\",\n      \"description\": \"å‘ä»¶äººæ˜¯å¦æ˜¯ä¸ªäººæˆ–å¤–éƒ¨å…¬å¸ï¼Ÿ(éœ€è¦ä½ é€šè¿‡å‘ä»¶äººçš„é‚®ä»¶åè¿›è¡Œåˆ¤æ–­æ˜¯ä¸æ˜¯ä¸ªäººé‚®ç®±æˆ–è€…æ˜¯å…¬å¸é‚®ç®±ï¼Œæ˜¯çš„è¯å¡«trueï¼›è¯·æ³¨æ„å¯¹äºcuhkåç¼€ä¸”åå­—åƒæœºæ„çš„é‚®ç®±å¦‚ curecruit@cuhk.edu.hk,artmuseumnews@cuhk.edu.hk,cumassmailing@cuhk.edu.hk,gip@cuhk.edu.hk,do_not_reply@cuhk.edu.hk,cpdc@cuhk.edu.hk,enf-pip@cuhk.edu.hk,lces@cuhk.edu.hk,SEDS@cuhk.edu.hk,leos@cuhk.edu.hk,do_not_reply@cuhk.edu.hk,student-election@cuhk.edu.hk,engineering@cuhk.edu.hk,mpss@cuhk.edu.hk,info@newsletter.cuhk.edu.hkå¡«false)\"\n    },\n    \"isImportantAcademicOrFee\": {\n      \"type\": \"boolean\",\n      \"description\": \"ã€æ ¸å¿ƒå­¦ä¸šå±æ€§ã€‘æ˜¯å¦æ¶‰åŠäº¤å­¦è´¹ã€äº¤å­¦æ‚è´¹ï¼ˆæ³¨æ„ï¼šæ™®é€šæ´»åŠ¨çš„æŠ¥åè´¹ä¸ç®—ï¼‰ã€äº¤ä½œä¸šã€æˆ–è€…ä¸è€ƒè¯•ï¼ˆExam/Test/Midterm/Finalï¼‰ç›´æ¥ç›¸å…³çš„è¯é¢˜ï¼Ÿ\"\n    },\n    \"hasDeadline\": {\n      \"type\": \"boolean\",\n      \"description\": \"æ˜¯å¦åŒ…å«æˆªæ­¢æ—¶é—´/æ—¥æœŸï¼Ÿï¼Œæ¯”å¦‚â€œæ˜å¤©æ¥æˆ‘åŠå…¬å®¤â€è¿™ç§è¡¨è¾¾ä¹Ÿç®—æ˜¯åŒ…å«æˆªæ­¢æ—¶é—´\"\n    },\n    \"isActivity\": {\n      \"type\": \"boolean\",\n      \"description\": \"æ˜¯å¦æ˜¯å…³äºè®²åº§ã€ç ”è®¨ä¼šã€å­¦ç”Ÿæ´»åŠ¨ã€æ¯”èµ›çš„ï¼Ÿ\"\n    },\n    \"isEngineeringOrEE\": {\n      \"type\": \"boolean\",\n      \"description\": \"å¦‚æœæ˜¯æ´»åŠ¨ï¼Œæ˜¯å¦å’Œå·¥ç¨‹å­¦é™¢(Engineering)æˆ–ç”µå­å·¥ç¨‹(EE)ç›¸å…³ï¼Ÿ\"\n    },\n    \"hasGiveaway\": {\n      \"type\": \"boolean\",\n      \"description\": \"æ˜¯å¦æåˆ°æœ‰å…è´¹èµ å“ã€æŠ½å¥–ã€çºªå¿µå“(souvenir/gift)ï¼Ÿ\"\n    },\n    \"isJobHunting\": {\n      \"type\": \"boolean\",\n      \"description\": \"æ˜¯å¦å…³äºæ±‚èŒã€æ‹›è˜æˆ–èŒåœºå‘å±•çš„ï¼Ÿ(ã€æ ¸å¿ƒå¼ºåˆ¶è§¦å‘è¯ã€‘ï¼šå®ä¹ /Internshipã€æ‹›è˜/Hiring/Recruitmentã€å®£è®²ä¼š/Recruitment Talkã€èŒä½/Jobã€ç®¡åŸ¹ç”Ÿ/MT/Graduate Programã€é¢è¯•/ç¬”è¯•ã€ç®€å†/CVã€Careerç­‰ã€‚åªè¦æ¶‰åŠå…¬å¸æä¾›å·¥ä½œæœºä¼šï¼Œå“ªæ€•æ ‡é¢˜æ˜¯è®²åº§ä¹Ÿå¿…é¡»å¡« true)\"\n    },\n    \"prefEmbedded\": {\n      \"type\": \"boolean\",\n      \"description\": \"æ˜¯å¦ä¸åµŒå…¥å¼æœ‰è”ç³»ï¼Ÿ\"\n    },\n    \"prefBigTech\": {\n      \"type\": \"boolean\",\n      \"description\": \"æ˜¯å¦æåˆ°çŸ¥åç§‘æŠ€å¤§å…¬å¸(å¦‚Google,è…¾è®¯,åä¸ºç­‰å¤§å‚)ï¼Ÿ\"\n    },\n    \"prefEntertainment\": {\n      \"type\": \"boolean\",\n      \"description\": \"æ˜¯å¦æåˆ°å¤å…¸ä¹ã€çº¯éŸ³ä¹ã€æ‘‡æ»šä¹ã€åŠ¨æ¼«æˆ–ç”µå½±ï¼Ÿ\"\n    },\n    \"isOverseasExchange\": {\n      \"type\": \"boolean\",\n      \"description\": \"æ˜¯å¦æ˜¯æµ·å¤–äº¤æµã€æš‘æœŸå­¦æ ¡ã€æµ·å¤–å‡å­¦ã€è®¿é—®å­¦è€…æˆ–äº¤æ¢ç”Ÿé¡¹ç›®ï¼Ÿ(Exchange program, Summer School, Study Abroad, è”åˆåŸ¹å…»ç­‰)\"\n    },\n    \"hasSubsidy\": {\n      \"type\": \"boolean\",\n      \"description\": \"æ˜¯å¦æ¶‰åŠåˆ°è¡¥è´´ã€å¥–å­¦é‡‘ã€æ´¥è´´æˆ–èµ„é‡‘æ”¯æŒï¼Ÿ(Subsidy, Allowance, Scholarship, Financial support, Funding, æŠ¥é”€ç­‰)\"\n    },\n    \"has_event\": {\n      \"type\": \"boolean\",\n      \"description\": \"ã€æ—¥å†æå–ã€‘é‚®ä»¶ä¸­æ˜¯å¦åŒ…å«å…·ä½“çš„æ´»åŠ¨ã€ä¸Šè¯¾ã€è®²åº§ã€å®£è®²ä¼šç­‰æœ‰æ˜ç¡®æ—¶é—´åœ°ç‚¹çš„äº‹é¡¹ï¼Œå€¼å¾—åŠ å…¥æ—¥å†ï¼Ÿ\"\n    },\n    \"event_title\": {\n      \"type\": \"string\",\n      \"description\": \"ã€æ—¥å†æå–ã€‘æ´»åŠ¨æˆ–äº‹ä»¶çš„åç§°ï¼ˆç®€æ˜æ‰¼è¦ï¼Œä¾‹å¦‚'ä¸­å¤§ç¬¬87æœŸæ™®é€šè¯æ°´å¹³æµ‹è¯•'ï¼‰ã€‚å¦‚æœæ²¡æœ‰åˆ™å¡«ç©ºå­—ç¬¦ä¸²ã€‚\"\n    },\n    \"start_time\": {\n      \"type\": \"string\",\n      \"description\": \"ã€æ—¥å†æå–ã€‘æ´»åŠ¨çš„å¼€å§‹æ—¶é—´ã€‚å¿…é¡»æ˜¯ ISO 8601 æ ¼å¼ä¸”åŒ…å«ä¸œå…«åŒºæ—¶åŒºæ ‡è¯†ï¼ˆä¾‹å¦‚ '2026-03-27T14:00:00+08:00'ï¼‰ã€‚å¦‚æœé‚®ä»¶æœªæåŠå¹´ä»½ï¼Œå¿…é¡»é»˜è®¤ä½¿ç”¨å½“å‰æ—¥æœŸçš„å¹´ä»½ã€‚å¦‚æœç¡®å®æ— æ³•æ¨ç®—ï¼Œå¡«ç©ºå­—ç¬¦ä¸²ã€‚\"\n    },\n    \"end_time\": {\n      \"type\": \"string\",\n      \"description\": \"ã€æ—¥å†æå–ã€‘æ´»åŠ¨çš„ç»“æŸæ—¶é—´ã€‚å¿…é¡»æ˜¯ ISO 8601 æ ¼å¼ä¸”å¸¦æ—¶åŒºã€‚å¦‚æœé‚®ä»¶ä¸­æ²¡å†™ç»“æŸæ—¶é—´ï¼Œè¯·ã€å¼ºåˆ¶ã€‘åœ¨å¼€å§‹æ—¶é—´ä¸Šé¡ºå»¶ 1 å°æ—¶ä½œä¸ºç»“æŸæ—¶é—´ã€‚å¦‚æœæ— æ³•æ¨ç®—ï¼Œå¡«ç©ºå­—ç¬¦ä¸²ã€‚\"\n    },\n    \"location\": {\n      \"type\": \"string\",\n      \"description\": \"ã€æ—¥å†æå–ã€‘æ´»åŠ¨çš„ä¸¾åŠåœ°ç‚¹ï¼ˆå¯ä»¥æ˜¯å…·ä½“çš„çº¿ä¸‹æ•™å®¤åç§°ï¼Œä¹Ÿå¯ä»¥æ˜¯ Zoom/Teams ç­‰çº¿ä¸Šä¼šè®®é“¾æ¥ï¼‰ã€‚å¦‚æœæ²¡æœ‰åœ°ç‚¹ä¿¡æ¯ï¼Œå¡«ç©ºå­—ç¬¦ä¸²ã€‚\"\n    },\n    \"emailSummary\": {\n      \"type\": \"string\",\n      \"description\": \"ç”¨å°½å¯èƒ½ç®€çŸ­ç²¾ç‚¼çš„è¯ç²¾å‡†æ€»ç»“è¿™å°é‚®ä»¶çš„æ ¸å¿ƒå†…å®¹ã€æ—¶é—´åœ°ç‚¹æˆ–æ ¸å¿ƒè¯‰æ±‚ä»¥åŠä¸æ»¡è¶³çš„propertiesæœ‰å…³çš„ç‚¹ï¼ˆè¦è¯´æ˜ç¬¦åˆæŸä¸ªpropertiesçš„å…·ä½“è”ç³»æ˜¯ä»€ä¹ˆï¼‰\"\n    }\n  },\n  \"required\": [\n    \"originalSender\",\n    \"isPersonalOrCompany\",\n    \"isImportantAcademicOrFee\",\n    \"hasDeadline\",\n    \"isActivity\",\n    \"isEngineeringOrEE\",\n    \"hasGiveaway\",\n    \"isJobHunting\",\n    \"prefEmbedded\",\n    \"prefBigTech\",\n    \"prefEntertainment\",\n    \"isOverseasExchange\",\n    \"hasSubsidy\",\n    \"has_event\",\n    \"event_title\",\n    \"start_time\",\n    \"end_time\",\n    \"location\",\n    \"emailSummary\"\n  ]\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        -1232,
        304
      ],
      "id": "8a53be71-0fb3-49bf-883c-1789f858304b",
      "name": "Structured Output Parser"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=è¯·åˆ†æä»¥ä¸‹é‚®ä»¶å†…å®¹ï¼š\n\nè¡¨é¢å‘ä»¶äºº: {{ $('è·å– Outlook é‚®ä»¶').item.json.bodyPreview }}\né‚®ä»¶æ ‡é¢˜: {{ $('è·å– Outlook é‚®ä»¶').item.json.subject }}\né‚®ä»¶æ­£æ–‡:\n{{ $json.finalbody }}\nå½“å‰é‚®ä»¶çš„å‘é€æ—¶é—´æ˜¯ï¼š{{ $('è·å– Outlook é‚®ä»¶').item.json.receivedDateTime }}ã€‚å¦‚æœåœ¨æå–æ´»åŠ¨æ—¥æœŸæ—¶æœªçœ‹åˆ°æ˜ç¡®å¹´ä»½ï¼Œè¯·å¿…é¡»ä»¥æ­¤å¹´ä»½ä¸ºåŸºå‡†è®¡ç®—ï¼",
        "hasOutputParser": true,
        "messages": {
          "messageValues": [
            {
              "message": "ä½ æ˜¯ä¸€ä¸ªç²¾å‡†çš„é‚®ä»¶åˆ†æåŠ©æ‰‹ã€‚è¿™æ‰¹é‚®ä»¶éƒ½æ˜¯ä»æˆ‘çš„æ•™è‚²é‚®ç®±è‡ªåŠ¨è½¬å‘åˆ°ä¸ªäººé‚®ç®±çš„ï¼Œå› æ­¤è¡¨é¢å‘ä»¶äººéƒ½æ˜¯æˆ‘è‡ªå·±ã€‚ä½ çš„ä»»åŠ¡æ˜¯é˜…è¯»é‚®ä»¶æ ‡é¢˜å’Œæ­£æ–‡ï¼Œå‰¥ç¦»è½¬å‘ä¿¡æ¯ï¼Œæ‰¾åˆ°çœŸæ­£çš„åŸå§‹å‘ä»¶äººï¼Œå¹¶æ ¹æ®å†…å®¹è¿›è¡Œåˆ†ç±»æ‰“æ ‡ã€‚ ã€è‡´å‘½è¦æ±‚ã€‘ä½ å¿…é¡»ä¸”åªèƒ½è¾“å‡ºåˆæ³•çš„ JSON æ ¼å¼å¯¹è±¡ï¼Œä¸è¦åŒ…å«ä»»ä½• Markdown ä»£ç å—æ ‡ç­¾ï¼ˆå¦‚ ```jsonï¼‰ï¼Œä¸è¦æœ‰ä»»ä½•å¤šä½™çš„åºŸè¯ã€‚"
            }
          ]
        },
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.9,
      "position": [
        -1376,
        144
      ],
      "id": "d987765e-3af4-4416-8cc5-cbc8f840b4f7",
      "name": "AI åˆ†æè¯­ä¹‰ä¸çœŸå®å‘ä»¶äºº"
    },
    {
      "parameters": {
        "resource": "message",
        "operation": "message:send",
        "receive_id": "ou_24d8dd986c2a1556784e00e2d4b26b9d",
        "text_content": "=ğŸš¨ **5åˆ†é‡è¦é‚®ä»¶æé†’**\n\n**çœŸå®å‘ä»¶äºº:** {{ $('AI åˆ†æè¯­ä¹‰ä¸çœŸå®å‘ä»¶äºº').item.json.output.originalSender }}\n**æ ‡é¢˜:** {{ $('è·å– Outlook é‚®ä»¶').item.json.subject }}\n\n**æ‘˜è¦:**\n{{ $('AI åˆ†æè¯­ä¹‰ä¸çœŸå®å‘ä»¶äºº').item.json.output.emailSummary }}\n\n**åŸæ–‡:**\n{{ $('è·å– Outlook é‚®ä»¶').item.json.bodyPreview }}",
        "options": {}
      },
      "type": "@luka-cat-mimi/n8n-nodes-feishu.feishuNode",
      "typeVersion": 1,
      "position": [
        240,
        -64
      ],
      "id": "6d2571ef-fdca-4a48-9950-0780d51d6318",
      "name": "é‡è¦é‚®ä»¶é€šçŸ¥",
      "webhookId": "c1c3fe1e-87bf-4d80-8ca8-35c3215e5a2e",
      "credentials": {
        "feishuNodeCredentialsApi": {
          "id": "BgoHzhnosSiOSmnt",
          "name": "é£ä¹¦ç§Ÿæˆ·ç»´åº¦ account"
        }
      }
    },
    {
      "parameters": {
        "includeTime": false,
        "options": {}
      },
      "type": "n8n-nodes-base.dateTime",
      "typeVersion": 2,
      "position": [
        -80,
        80
      ],
      "id": "2b8a44d7-92ec-41e1-889d-8731dd2783b9",
      "name": "Date & Time"
    },
    {
      "parameters": {
        "toRecipients": "lpz2025apply@163.com",
        "subject": "=â—{{ $today }}é‡è¦é‚®ä»¶æé†’",
        "bodyContent": "=ğŸš¨ **5åˆ†é‡è¦é‚®ä»¶æé†’**\n\n**çœŸå®å‘ä»¶äºº:** {{ $('AI åˆ†æè¯­ä¹‰ä¸çœŸå®å‘ä»¶äºº').item.json.output.originalSender }}\n**æ ‡é¢˜:** {{ $('è·å– Outlook é‚®ä»¶').item.json.subject }}\n\n**æ‘˜è¦:**\n{{ $('AI åˆ†æè¯­ä¹‰ä¸çœŸå®å‘ä»¶äºº').item.json.output.emailSummary }}\n\n**åŸæ–‡:**\n{{ $('è·å– Outlook é‚®ä»¶').item.json.bodyPreview }}",
        "additionalFields": {}
      },
      "id": "68420791-c1f4-4ef7-a9a1-99f7740bc596",
      "name": "é‚®ä»¶æé†’",
      "type": "n8n-nodes-base.microsoftOutlook",
      "typeVersion": 2,
      "position": [
        256,
        112
      ],
      "webhookId": "b20b1505-1cd8-4cf5-bb4b-14c9f726f716",
      "credentials": {
        "microsoftOutlookOAuth2Api": {
          "id": "zosb6ZPeueosMnPx",
          "name": "Microsoft Outlook account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "messageId": {
          "__rl": true,
          "value": "={{ $('è·å– Outlook é‚®ä»¶').item.json.id }}",
          "mode": "id"
        },
        "updateFields": {
          "isRead": true
        }
      },
      "id": "56e244cb-3667-4923-ad32-1e1eb03a9f2c",
      "name": "å¤„ç†è¿‡çš„é‚®ç®±æ ‡è®°ä¸ºå·²è¯»",
      "type": "n8n-nodes-base.microsoftOutlook",
      "typeVersion": 2,
      "position": [
        -752,
        144
      ],
      "webhookId": "5f443408-6f7e-4ae1-ba94-5bbfe85d455b",
      "credentials": {
        "microsoftOutlookOAuth2Api": {
          "id": "zosb6ZPeueosMnPx",
          "name": "Microsoft Outlook account"
        }
      }
    },
    {
      "parameters": {
        "html": "={{ $('è·å– Outlook é‚®ä»¶').item.json.body.content }}",
        "destinationKey": "markdownBody",
        "options": {
          "maxConsecutiveNewlines": 2
        }
      },
      "type": "n8n-nodes-base.markdown",
      "typeVersion": 1,
      "position": [
        -2160,
        -96
      ],
      "id": "e74b7fda-fdb9-444a-bd2f-6764b3a7e542",
      "name": "Markdown"
    },
    {
      "parameters": {
        "model": "qwen/qwen3-vl-235b-a22b-instruct",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        -2512,
        48
      ],
      "id": "38cddac3-b076-4b71-8cec-7de4008708a5",
      "name": "OpenRouter Chat Model",
      "credentials": {
        "openRouterApi": {
          "id": "niTTJMgDXKbj44jJ",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "è¯·åˆ†æä»¥ä¸‹å›¾ç‰‡å†…å®¹",
        "messages": {
          "messageValues": [
            {
              "type": "HumanMessagePromptTemplate",
              "messageType": "imageBinary",
              "binaryImageDataKey": "=target_image"
            }
          ]
        },
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.9,
      "position": [
        -2512,
        -96
      ],
      "id": "f5a61a1a-92f1-4cf1-829f-de44dfae6524",
      "name": "AIè¯†åˆ«é™„ä»¶çš„å›¾ç‰‡ä¿¡æ¯"
    },
    {
      "parameters": {
        "jsCode": "const newItems = [];\n\nfor (const item of $input.all()) {\n  let hasImage = false;\n  let targetImage = null;\n\n  // æ£€æŸ¥æ˜¯å¦æœ‰å›¾ç‰‡é™„ä»¶\n  if (item.binary) {\n    for (const key of Object.keys(item.binary)) {\n      const file = item.binary[key];\n      if (file.mimeType && file.mimeType.startsWith('image/')) {\n        hasImage = true;\n        targetImage = file;\n        break; // æ‰¾åˆ°ç¬¬ä¸€å¼ å›¾å°±åœæ­¢\n      }\n    }\n  }\n\n  // æ— è®ºæœ‰æ²¡æœ‰å›¾ç‰‡ï¼Œéƒ½æŠŠé‚®ä»¶æ”¾è¡Œï¼Œä½†æ‰“ä¸Šä¸åŒçš„æ ‡ç­¾\n  if (hasImage) {\n    newItems.push({\n      json: { ...item.json, has_image: true },\n      binary: { target_image: targetImage } // å‡†å¤‡å¥½å›¾ç‰‡ç»™ AI\n    });\n  } else {\n    newItems.push({\n      json: { ...item.json, has_image: false },\n      binary: item.binary // ä¿æŒåŸæ ·\n    });\n  }\n}\n\nreturn newItems;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2944,
        160
      ],
      "id": "da8b84e9-e484-40b6-924e-1aa1836dfa2e",
      "name": "Code in JavaScript"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "ec543604-b19f-4690-954a-a72488dffc02",
              "leftValue": "={{ $json.has_image }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -2768,
        160
      ],
      "id": "0b17f856-5c74-413b-b2af-e322028acd90",
      "name": "If"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -1616,
        144
      ],
      "id": "ed396884-1166-4c6f-99f3-a467675cda37",
      "name": "Merge"
    },
    {
      "parameters": {
        "html": "={{ $('è·å– Outlook é‚®ä»¶').item.json.body.content }}",
        "destinationKey": "markdownBody",
        "options": {
          "maxConsecutiveNewlines": 2
        }
      },
      "type": "n8n-nodes-base.markdown",
      "typeVersion": 1,
      "position": [
        -2320,
        176
      ],
      "id": "7f2cc6cf-49d3-4b75-8570-554c7e70442c",
      "name": "Markdown1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "bfbea9ce-9abd-45f7-b869-cc26be3d65d3",
              "name": "finalbody",
              "value": "={{ $json.markdownBody }} é‚®ä»¶çš„å›¾ç‰‡å†…å®¹å¦‚ä¸‹ï¼š{{ $json.text }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1936,
        -96
      ],
      "id": "da319dfa-391d-436a-aca8-7fc8e2e8c416",
      "name": "mdæ­£æ–‡å’Œå›¾ç‰‡åˆ†ææ‹¼æ¥å­—æ®µåˆ›å»º"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "bfbea9ce-9abd-45f7-b869-cc26be3d65d3",
              "name": "finalbody",
              "value": "={{ $json.markdownBody }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1968,
        176
      ],
      "id": "107df279-376b-4234-b0ea-9b749365b52e",
      "name": "æ­£æ–‡å­—æ®µåˆ›å»º"
    },
    {
      "parameters": {
        "resource": "folder",
        "operation": "getAll",
        "returnAll": true,
        "filters": {},
        "options": {}
      },
      "id": "45eaa311-6827-47d6-9f3d-bd83ca81481e",
      "name": "è·å– Outlook æ¯ä¸ªåˆ†ç±»å¤¹çš„id",
      "type": "n8n-nodes-base.microsoftOutlook",
      "typeVersion": 2,
      "position": [
        -3392,
        -384
      ],
      "webhookId": "5f443408-6f7e-4ae1-ba94-5bbfe85d455b",
      "credentials": {
        "microsoftOutlookOAuth2Api": {
          "id": "zosb6ZPeueosMnPx",
          "name": "Microsoft Outlook account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "4c0c3ce5-77e1-4dbe-9f6a-23f634fff15b",
              "leftValue": "={{ $json.output.has_event }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -944,
        608
      ],
      "id": "775ee093-8a47-43d8-a4ef-129d4afcf7f8",
      "name": "åˆ¤æ–­é‚®ä»¶ä¸­æ˜¯å¦åŒ…å«å€¼å¾—å†™è¿›æ—¥å†çš„äº‹é¡¹"
    },
    {
      "parameters": {
        "resource": "event",
        "operation": "create",
        "calendarId": {
          "__rl": true,
          "value": "AQMkADAwATM0MDAAMS0wMzRlLWU0ZDQtMDACLTAwCgBGAAADGxqcrOJwqkOUDVnFcw_6SQcAhrNBk7nAs0q97X6LwbAwYQAAAgEGAAAAhrNBk7nAs0q97X6LwbAwYQAHwsXYzwAAAA==",
          "mode": "list",
          "cachedResultName": "AIæ—¥å†"
        },
        "subject": "={{ $('AI åˆ†æè¯­ä¹‰ä¸çœŸå®å‘ä»¶äºº').item.json.output.event_title }}",
        "startDateTime": "={{ $('AI åˆ†æè¯­ä¹‰ä¸çœŸå®å‘ä»¶äºº').item.json.output.start_time }}",
        "endDateTime": "={{ $('AI åˆ†æè¯­ä¹‰ä¸çœŸå®å‘ä»¶äºº').item.json.output.end_time }}",
        "additionalFields": {
          "body": "={{ $('AI åˆ†æè¯­ä¹‰ä¸çœŸå®å‘ä»¶äºº').item.json.output.emailSummary }}",
          "bodyPreview": "={{ $('AI åˆ†æè¯­ä¹‰ä¸çœŸå®å‘ä»¶äºº').item.json.output.location }}"
        }
      },
      "type": "n8n-nodes-base.microsoftOutlook",
      "typeVersion": 2,
      "position": [
        -624,
        592
      ],
      "id": "c24d2a90-5c08-472d-be3a-53482d30a44d",
      "name": "é‡è¦äº‹é¡¹å†™è¿›æ—¥å†",
      "webhookId": "18ae49fe-a009-4417-85f2-ad605a61fa77",
      "credentials": {
        "microsoftOutlookOAuth2Api": {
          "id": "zosb6ZPeueosMnPx",
          "name": "Microsoft Outlook account"
        }
      }
    },
    {
      "parameters": {
        "model": "qwen/qwen3.5-plus-02-15",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        -1376,
        320
      ],
      "id": "9a081c82-b11c-4592-82c1-657beda96ab2",
      "name": "OpenRouter Chat Model1",
      "credentials": {
        "openRouterApi": {
          "id": "niTTJMgDXKbj44jJ",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "command": "=echo '{\"subject\":\"{{ $('è·å– Outlook é‚®ä»¶').item.json.subject }}\", \"sender\":\"{{ $('AI åˆ†æè¯­ä¹‰ä¸çœŸå®å‘ä»¶äºº').item.json.output.originalSender }}\", \"score\":{{ $('æ‰“åˆ†å¼•æ“ä¸è·¯ç”±è®¡ç®—').item.json.finalScore }}, \"category\":\"{{ $('æ‰“åˆ†å¼•æ“ä¸è·¯ç”±è®¡ç®—').item.json.emailCategory }}\", \"content\":\"{{ $('æ‰“åˆ†å¼•æ“ä¸è·¯ç”±è®¡ç®—').item.json.output.emailSummary }}\"}' >> /files/daily_emails.jsonl"
      },
      "id": "f2daaf60-5c26-48f3-8642-0e7cfab9de7d",
      "name": "è¿½åŠ è‡³æœ¬åœ° JSONL1",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [
        496,
        112
      ]
    }
  ],
  "connections": {
    "æ¯10åˆ†é’Ÿè§¦å‘": {
      "main": [
        [
          {
            "node": "è·å– Outlook é‚®ä»¶",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "è·å– Outlook é‚®ä»¶": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æ‰“åˆ†å¼•æ“ä¸è·¯ç”±è®¡ç®—": {
      "main": [
        [
          {
            "node": "å¤„ç†è¿‡çš„é‚®ç®±æ ‡è®°ä¸ºå·²è¯»",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "åŠ¨æ€ç§»åŠ¨è‡³å¯¹åº”æ–‡ä»¶å¤¹": {
      "main": [
        [
          {
            "node": "æ»¡åˆ† 5 åˆ†?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æ»¡åˆ† 5 åˆ†?": {
      "main": [
        [
          {
            "node": "Date & Time",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "å¤§äºç­‰äº 2 åˆ†?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å¤§äºç­‰äº 2 åˆ†?": {
      "main": [
        [
          {
            "node": "è¿½åŠ è‡³æœ¬åœ° JSONL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Structured Output Parser": {
      "ai_outputParser": [
        [
          {
            "node": "AI åˆ†æè¯­ä¹‰ä¸çœŸå®å‘ä»¶äºº",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "AI åˆ†æè¯­ä¹‰ä¸çœŸå®å‘ä»¶äºº": {
      "main": [
        [
          {
            "node": "æ‰“åˆ†å¼•æ“ä¸è·¯ç”±è®¡ç®—",
            "type": "main",
            "index": 0
          },
          {
            "node": "åˆ¤æ–­é‚®ä»¶ä¸­æ˜¯å¦åŒ…å«å€¼å¾—å†™è¿›æ—¥å†çš„äº‹é¡¹",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Date & Time": {
      "main": [
        [
          {
            "node": "é‡è¦é‚®ä»¶é€šçŸ¥",
            "type": "main",
            "index": 0
          },
          {
            "node": "é‚®ä»¶æé†’",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "é‚®ä»¶æé†’": {
      "main": [
        [
          {
            "node": "è¿½åŠ è‡³æœ¬åœ° JSONL1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å¤„ç†è¿‡çš„é‚®ç®±æ ‡è®°ä¸ºå·²è¯»": {
      "main": [
        [
          {
            "node": "åŠ¨æ€ç§»åŠ¨è‡³å¯¹åº”æ–‡ä»¶å¤¹",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Markdown": {
      "main": [
        [
          {
            "node": "mdæ­£æ–‡å’Œå›¾ç‰‡åˆ†ææ‹¼æ¥å­—æ®µåˆ›å»º",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenRouter Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AIè¯†åˆ«é™„ä»¶çš„å›¾ç‰‡ä¿¡æ¯",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "AIè¯†åˆ«é™„ä»¶çš„å›¾ç‰‡ä¿¡æ¯": {
      "main": [
        [
          {
            "node": "Markdown",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "AIè¯†åˆ«é™„ä»¶çš„å›¾ç‰‡ä¿¡æ¯",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Markdown1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "AI åˆ†æè¯­ä¹‰ä¸çœŸå®å‘ä»¶äºº",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Markdown1": {
      "main": [
        [
          {
            "node": "æ­£æ–‡å­—æ®µåˆ›å»º",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "mdæ­£æ–‡å’Œå›¾ç‰‡åˆ†ææ‹¼æ¥å­—æ®µåˆ›å»º": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æ­£æ–‡å­—æ®µåˆ›å»º": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "åˆ¤æ–­é‚®ä»¶ä¸­æ˜¯å¦åŒ…å«å€¼å¾—å†™è¿›æ—¥å†çš„äº‹é¡¹": {
      "main": [
        [
          {
            "node": "é‡è¦äº‹é¡¹å†™è¿›æ—¥å†",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenRouter Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "AI åˆ†æè¯­ä¹‰ä¸çœŸå®å‘ä»¶äºº",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "6a61b0819ff43abcea0ee93ce4487f18bd53629fda8e5628f474139c9c98638d"
  }
}
